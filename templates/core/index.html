{% extends 'core/base.html' %}
{% load static %}

{% block title %}Inicio - Cadmium{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/index.css' %}">
{% endblock %}

{% block content %}
<!-- Navbar -->
<nav class="navbar">
    <a href="{% url 'index' %}" class="navbar-brand">
        <div class="navbar-logo">
            <img src="{% static 'images/logo/logo.png' %}" alt="Cadmium Logo" class="navbar-logo-img" data-logo-svg="{% static 'images/logo/logo.svg' %}" onerror="handleLogoError(this)">
            <span class="logo-fallback" style="display: none;">C</span>
        </div>
        <div>
            <span>Cadmium</span>
            <span class="tagline">Crea tu mundo</span>
        </div>
    </a>
    <div class="navbar-nav">
        <div class="dropdown">
            <a href="#" class="dropdown-toggle nav-link" onclick="toggleDropdown(event)">
                <span class="hamburger-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </span>
            </a>
            <div class="dropdown-menu">
                {% if user.is_authenticated %}
                    <span class="dropdown-item welcome-item">游녦 Bienvenido/a {{ user.nombre|default:user.username }}</span>
                    {% if user.es_administrador or user.is_superuser %}
                        <a href="{% url 'panel' %}" class="dropdown-item">游늵 Mi Panel</a>
                    {% elif user.es_empleado %}
                        <a href="{% url 'trabajador_dashboard' %}" class="dropdown-item">游늵 Mi Panel</a>
                    {% endif %}
                {% else %}
                    <a href="{% url 'login' %}" class="dropdown-item">游댏 Iniciar Sesi칩n</a>
                {% endif %}
                <a href="{% url 'contactanos' %}" class="dropdown-item">游 Cont치ctanos</a>
                <a href="{% url 'documentacion' %}" class="dropdown-item">游닄 Documentaci칩n</a>
                {% if user.is_authenticated %}
                    <a href="{% url 'logout' %}" class="dropdown-item">游뛁 Cerrar Sesi칩n</a>
                {% endif %}
            </div>
        </div>
    </div>
</nav>

<!-- Mensajes -->
{% if messages %}
    <div class="alert-container" style="position: fixed; top: 70px; left: 50%; transform: translateX(-50%); z-index: 9999; max-width: 500px; width: 90%;">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags|default:'info' }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

<!-- Hero Section with Carousel -->
<div class="hero-section">
    <div class="carousel-container">
        <div class="carousel">
            <div class="carousel-inner">
                {% for item in imagenes_carrusel %}
                    <div class="carousel-item {% if forloop.first %}active{% endif %}" data-slide-index="{{ forloop.counter0 }}">
                        <img src="{{ item.imagen.imagen.url }}" alt="Imagen {{ item.indice }}" class="carousel-image" loading="lazy">
                        {% if item.titulo_barista or item.imagen.titulo_barista %}
                            <div class="carousel-barista-overlay">
                                <div class="barista-badge">
                                    <span class="barista-icon">游끥</span>
                                    <span class="barista-text">Barista del Mes: {{ item.titulo_barista|default:item.imagen.titulo_barista }}</span>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            <button class="carousel-controls carousel-prev">&#10094;</button>
            <button class="carousel-controls carousel-next">&#10095;</button>
            <div class="carousel-indicators">
                {% for item in imagenes_carrusel %}
                    <span class="carousel-indicator {% if forloop.first %}active{% endif %}" data-slide-index="{{ forloop.counter0 }}"></span>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- App Icon Section -->
<div class="app-icon-section">
    <div class="app-icon">
        <img src="{% static 'images/logo/logo.png' %}" alt="Cadmium Logo" class="app-icon-img" data-logo-svg="{% static 'images/logo/logo.svg' %}" onerror="handleLogoError(this)">
        <span class="logo-fallback" style="display: none; font-size: 4.5rem; font-weight: bold;">C</span>
    </div>
    <h2 class="app-title">Cadmium</h2>
    <p class="app-subtitle">PopUp Nescafe</p>
</div>

<!-- News and Events Section -->
<div class="news-section">
    <div class="news-container">
        <h2 class="section-title">Noticias y Eventos Importantes</h2>
        <div class="news-grid">
            {% if eventos %}
                {% for evento in eventos %}
                <div class="news-card">
                    {% if evento.imagen %}
                        <div class="news-card-image">
                            <img src="{{ evento.imagen.url }}" alt="{{ evento.titulo }}" class="news-image">
                        </div>
                    {% endif %}
                    <div class="news-card-content">
                        <div class="news-category">游늰 Eventos PopUp</div>
                        <h3 class="news-card-title">{{ evento.titulo }}</h3>
                        <div class="news-description-wrapper">
                            <p class="news-description news-description-short">{{ evento.descripcion|truncatewords:30 }}</p>
                            <div class="news-description news-description-full">{{ evento.descripcion|linebreaks }}</div>
                        </div>
                        <button class="btn-show-more" onclick="toggleDescription(this)" data-short="{{ evento.descripcion|truncatewords:30|striptags }}" data-full="{{ evento.descripcion|striptags }}" style="display: none;">Mostrar m치s</button>
                        <div class="news-date">Fecha: {{ evento.fecha_evento|date:"d/m/Y" }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="news-card">
                    <div class="news-card-content">
                        <div class="news-category">游늰 Eventos PopUp</div>
                        <h3 class="news-card-title">Eventos PopUp</h3>
                        <p class="news-description">Mantente al d칤a con las 칰ltimas noticias y eventos importantes del PopUp Nescafe. Aqu칤 encontrar치s informaci칩n relevante sobre actividades, anuncios y comunicados.</p>
                        <div class="news-date">Fecha: Pr칩ximamente</div>
                    </div>
                </div>
            {% endif %}
            
            {% if noticias %}
                {% for noticia in noticias %}
                <div class="news-card">
                    {% if noticia.imagen %}
                        <div class="news-card-image">
                            <img src="{{ noticia.imagen.url }}" alt="{{ noticia.titulo }}" class="news-image">
                        </div>
                    {% endif %}
                    <div class="news-card-content">
                        <div class="news-category">游닗 Noticias y Actualizaciones</div>
                        <h3 class="news-card-title">{{ noticia.titulo }}</h3>
                        <div class="news-description-wrapper">
                            <p class="news-description news-description-short">{{ noticia.descripcion|truncatewords:30 }}</p>
                            <div class="news-description news-description-full">{{ noticia.descripcion|linebreaks }}</div>
                        </div>
                        <button class="btn-show-more" onclick="toggleDescription(this)" data-short="{{ noticia.descripcion|truncatewords:30|striptags }}" data-full="{{ noticia.descripcion|striptags }}" style="display: none;">Mostrar m치s</button>
                        <div class="news-date">Fecha: {{ noticia.fecha_publicacion|date:"d/m/Y" }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="news-card">
                    <div class="news-card-content">
                        <div class="news-category">游닗 Noticias y Actualizaciones</div>
                        <h3 class="news-card-title">Noticias y Actualizaciones</h3>
                        <p class="news-description">Informaci칩n actualizada sobre el funcionamiento del sistema y las actividades del PopUp Nescafe. Consulta regularmente para estar informado.</p>
                        <div class="news-date">Fecha: Pr칩ximamente</div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Social Media Floating Button -->
<div class="social-float-btn">
    <div class="social-bar">
        <a href="https://www.tiktok.com/@creatumundoinacapsur" target="_blank" rel="noopener noreferrer" class="social-link tiktok" title="S칤guenos en TikTok">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/>
            </svg>
        </a>
        <a href="https://www.instagram.com/creatumundo_inacapsur/" target="_blank" rel="noopener noreferrer" class="social-link instagram" title="S칤guenos en Instagram">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
            </svg>
        </a>
    </div>
    <div class="social-btn-main" title="S칤guenos en redes sociales">
        <img src="{% static 'images/social/social.png' %}" alt="Redes sociales" style="width: 30px; height: 30px; object-fit: contain;">
    </div>
</div>

<!-- Footer -->
<footer class="footer">
    <div class="footer-content">
        <p>&copy; 2025 Cadmium. Todos los derechos reservados.</p>
        <p style="margin-top: 5px;">Desarrollado por: Tania Vilches, Annais Galvez, Alberto San Juan</p>
        <p style="margin-top: 10px;">
            <a href="{% url 'equipo' %}" style="color: rgba(255, 255, 255, 0.8); text-decoration: underline; transition: color 0.3s ease; margin-right: 15px;">Conoce al Equipo</a>
            <a href="{% url 'creditos' %}" style="color: rgba(255, 255, 255, 0.8); text-decoration: underline; transition: color 0.3s ease;">Cr칠ditos</a>
        </p>
    </div>
</footer>

<script>

    // Variables globales para el carrusel
    let currentSlideIndex = 0;
    let slides = [];
    let indicators = [];
    let totalSlides = 0;
    let carouselInterval = null;
    let isTransitioning = false; // Flag para prevenir transiciones simult치neas
    let transitionTimeout = null;

    function initCarousel() {
        slides = document.querySelectorAll('.carousel-item');
        indicators = document.querySelectorAll('.carousel-indicator');
        totalSlides = slides.length;

        // Verificar que hay slides
        if (totalSlides === 0) {
            console.warn('No se encontraron im치genes en el carrusel');
            return;
        }

        // Limpiar intervalo anterior si existe
        if (carouselInterval) {
            clearInterval(carouselInterval);
            carouselInterval = null;
        }

        // Inicializar: asegurar que solo la primera slide est칠 activa
        slides.forEach((slide, index) => {
            if (index === 0) {
                slide.classList.add('active');
            } else {
                slide.classList.remove('active');
            }
        });
        
        // Inicializar indicadores
        indicators.forEach((indicator, index) => {
            if (index === 0) {
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
            // A침adir event listener a cada indicador
            const slideIndexAttr = indicator.getAttribute('data-slide-index');
            const slideIndex = slideIndexAttr !== null ? parseInt(slideIndexAttr) : index;
            indicator.addEventListener('click', () => {
                goToSlide(slideIndex);
            });
        });

        // A침adir event listeners a los botones de control con throttling
        const prevButton = document.querySelector('.carousel-prev');
        const nextButton = document.querySelector('.carousel-next');
        if (prevButton) {
            prevButton.addEventListener('click', () => {
                if (!isTransitioning) {
                    changeSlide(-1);
                }
            });
        }
        if (nextButton) {
            nextButton.addEventListener('click', () => {
                if (!isTransitioning) {
                    changeSlide(1);
                }
            });
        }

        // Auto-play del carrusel cada 4 segundos (solo si hay m치s de una imagen)
        startAutoPlay();

        // Hacer funciones globales para compatibilidad
        window.changeSlide = changeSlide;
        window.currentSlide = currentSlide;
    }

    function startAutoPlay() {
        if (carouselInterval) {
            clearInterval(carouselInterval);
        }
        if (totalSlides > 1) {
            carouselInterval = setInterval(() => {
                if (!isTransitioning) {
                    changeSlide(1);
                }
            }, 4000);
        }
    }

    function stopAutoPlay() {
        if (carouselInterval) {
            clearInterval(carouselInterval);
            carouselInterval = null;
        }
    }

    function goToSlide(index) {
        if (isTransitioning || index === currentSlideIndex) {
            return;
        }
        
        // Calcular el nuevo 칤ndice
        if (index >= totalSlides) {
            currentSlideIndex = 0;
        } else if (index < 0) {
            currentSlideIndex = totalSlides - 1;
        } else {
            currentSlideIndex = index;
        }
        
        updateCarousel();
        // Reiniciar auto-play cuando el usuario interact칰a
        startAutoPlay();
    }

    function updateCarousel() {
        if (isTransitioning) {
            return;
        }
        
        isTransitioning = true;
        
        // Usar requestAnimationFrame para mejor rendimiento
        requestAnimationFrame(() => {
            // Ocultar todas las slides y mostrar solo la actual
            for (let i = 0; i < slides.length; i++) {
                if (i === currentSlideIndex) {
                    slides[i].classList.add('active');
                } else {
                    slides[i].classList.remove('active');
                }
            }
            
            // Actualizar indicadores
            for (let i = 0; i < indicators.length; i++) {
                if (i === currentSlideIndex) {
                    indicators[i].classList.add('active');
                } else {
                    indicators[i].classList.remove('active');
                }
            }
            
            // Permitir nueva transici칩n despu칠s de un breve delay
            if (transitionTimeout) {
                clearTimeout(transitionTimeout);
            }
            transitionTimeout = setTimeout(() => {
                isTransitioning = false;
            }, 300); // Menor que la duraci칩n de la transici칩n CSS (0.5s)
        });
    }

    function changeSlide(direction) {
        if (isTransitioning) {
            return;
        }
        
        stopAutoPlay();
        
        let newIndex = currentSlideIndex + direction;
        
        if (newIndex >= totalSlides) {
            newIndex = 0;
        } else if (newIndex < 0) {
            newIndex = totalSlides - 1;
        }
        
        currentSlideIndex = newIndex;
        updateCarousel();
        
        // Reiniciar auto-play despu칠s de un delay
        setTimeout(() => {
            startAutoPlay();
        }, 500);
    }

    function currentSlide(index) {
        if (isTransitioning) {
            return;
        }
        stopAutoPlay();
        goToSlide(index - 1);
    }

    // Inicializar cuando el DOM est칠 listo
    document.addEventListener('DOMContentLoaded', function() {
        initCarousel();
    });

    // Tambi칠n intentar inicializar inmediatamente por si el DOM ya est치 listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCarousel);
    } else {
        initCarousel();
    }

    // Funci칩n para el men칰 desplegable
    function toggleDropdown(event) {
        event.preventDefault();
        const dropdown = event.currentTarget.closest('.dropdown');
        dropdown.classList.toggle('active');
    }

    // Cerrar el men칰 al hacer clic fuera
    document.addEventListener('click', function(event) {
        const dropdowns = document.querySelectorAll('.dropdown');
        dropdowns.forEach(dropdown => {
            if (!dropdown.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });
    });

    // Funci칩n para verificar si el texto est치 truncado y mostrar el bot칩n
    function checkTextTruncation() {
        document.querySelectorAll('.news-card').forEach(card => {
            const button = card.querySelector('.btn-show-more');
            if (!button) return;
            
            const shortText = button.getAttribute('data-short') || '';
            const fullText = button.getAttribute('data-full') || '';
            
            // Si no hay texto, ocultar bot칩n
            if (!shortText || !fullText) {
                button.style.display = 'none';
                return;
            }
            
            // Limpiar y normalizar textos (eliminar espacios extra)
            const shortClean = shortText.trim().replace(/\s+/g, ' ');
            const fullClean = fullText.trim().replace(/\s+/g, ' ');
            
            // Contar palabras (filtrar palabras vac칤as)
            const shortWords = shortClean.split(/\s+/).filter(function(w) { return w.length > 0; });
            const fullWords = fullClean.split(/\s+/).filter(function(w) { return w.length > 0; });
            
            // Verificar si el texto completo tiene significativamente m치s palabras
            // (m치s de 5 palabras adicionales para considerar que hay truncamiento real)
            const wordDifference = fullWords.length - shortWords.length;
            const hasMoreWords = wordDifference > 5;
            
            // Verificar que el texto cortado es el inicio del texto completo
            // Tomar los primeros 80 caracteres de cada uno para comparar
            const shortStart = shortClean.substring(0, 80).toLowerCase();
            const fullStart = fullClean.substring(0, 80).toLowerCase();
            
            // El texto est치 truncado si:
            // 1. Hay m치s palabras en el texto completo
            // 2. Y el inicio del texto cortado coincide con el inicio del texto completo
            const isTruncated = hasMoreWords && (
                fullStart.indexOf(shortStart.substring(0, 60)) === 0 ||
                shortStart.length > 0 && fullStart.substring(0, Math.min(fullStart.length, shortStart.length + 20)).indexOf(shortStart.substring(0, 50)) >= 0
            );
            
            // Mostrar u ocultar el bot칩n seg칰n si hay truncamiento
            button.style.display = isTruncated ? 'block' : 'none';
        });
    }

    // Funci칩n para mostrar/ocultar descripci칩n completa
    function toggleDescription(button) {
        const card = button.closest('.news-card-content');
        const shortDesc = card.querySelector('.news-description-short');
        const fullDesc = card.querySelector('.news-description-full');
        
        if (fullDesc.classList.contains('show')) {
            // Ocultar descripci칩n completa - mostrar corta
            shortDesc.classList.remove('hide');
            fullDesc.classList.remove('show');
            button.textContent = 'Mostrar m치s';
            button.classList.remove('active');
        } else {
            // Mostrar descripci칩n completa - ocultar corta
            shortDesc.classList.add('hide');
            fullDesc.classList.add('show');
            button.textContent = 'Mostrar menos';
            button.classList.add('active');
        }
    }

    // Ejecutar la verificaci칩n cuando la p치gina cargue
    document.addEventListener('DOMContentLoaded', function() {
        // Asegurar que solo se muestre el texto corto inicialmente
        document.querySelectorAll('.news-description-full').forEach(function(fullDesc) {
            fullDesc.classList.remove('show');
        });
        document.querySelectorAll('.news-description-short').forEach(function(shortDesc) {
            shortDesc.classList.remove('hide');
        });
        
        // Verificar truncamiento y mostrar/ocultar botones
        checkTextTruncation();
    });
</script>
{% endblock %}

